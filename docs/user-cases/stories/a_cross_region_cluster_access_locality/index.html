<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Nearest Cluster Access Across Two Cloud Providers #  Service Requirements #  To ensure the high availability of the Elasticsearch service, Zuoyebang deploys a single Elasticsearch cluster on both Baidu Cloud and Huawei Cloud and requires that service requests be sent to the nearest cloud first.
Deployment of a Single Elasticsearch Cluster on Dual Clouds #  The Elasticsearch cluster uses an architecture with master nodes separated from data nodes."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Nearest Cluster Access Across Two Cloud Providers"><meta property="og:description" content="Nearest Cluster Access Across Two Cloud Providers #  Service Requirements #  To ensure the high availability of the Elasticsearch service, Zuoyebang deploys a single Elasticsearch cluster on both Baidu Cloud and Huawei Cloud and requires that service requests be sent to the nearest cloud first.
Deployment of a Single Elasticsearch Cluster on Dual Clouds #  The Elasticsearch cluster uses an architecture with master nodes separated from data nodes."><meta property="og:type" content="article"><meta property="og:url" content="/docs/user-cases/stories/a_cross_region_cluster_access_locality/"><title>Nearest Cluster Access Across Two Cloud Providers | INFINI Gateway</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=alternate hreflang=zh href=/zh/docs/user-cases/stories/a_cross_region_cluster_access_locality/ title=作业帮跨云集群的就近本地访问><link rel=stylesheet href=/book.min.86778a3f4df1b5b61556a975dd0ee3bd2c03aeee5a2e203fb93ecbd71224869e.css integrity="sha256-hneKP03xtbYVVql13Q7jvSwDru5aLiA/uT7L1xIkhp4="><script defer src=/en.search.min.35ecdbc4b004fe04886dc86c3cb0d729eab3c74bdb861a2e8df23ce8d2242cc2.js integrity="sha256-NezbxLAE/gSIbchsPLDXKeqzx0vbhhoujfI86NIkLMI="></script><script defer src=/js/jquery-2.x.min.js></script><script defer src=/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><img src=/img/logo-en.svg alt=Logo></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/overview/>Overview</a><ul></ul></li><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>Quick Start</a>
<span>▾</span></label><ul><li><a href=/docs/getting-started/install/>Installing the Gateway</a></li><li><a href=/docs/getting-started/configuration/>Configuring the Gateway</a></li><li><a href=/docs/getting-started/docker/>Container Deployment</a></li><li><a href=/docs/getting-started/optimization/>System Optimization</a></li><li><a href=/docs/getting-started/benchmark/>Performance Test</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a>Reference</a>
<span>▾</span></label><ul><li><a href=/docs/references/entry/>Service Entry</a></li><li><a href=/docs/references/router/>Service Router</a></li><li><a href=/docs/references/flow/>Handling Flow</a></li><li><a href=/docs/references/elasticsearch/>Elasticsearch</a></li><li><a href=/docs/references/context/>Request Context</a></li><li><input type=checkbox id=section-a53d1bd91095fa28aef70cee327a5121 class=toggle>
<label for=section-a53d1bd91095fa28aef70cee327a5121 class="flex justify-between"><a href=/docs/references/filters/>Online Filter</a>
<span>▾</span></label><ul><li><a href=/docs/references/filters/echo/>echo</a></li><li><a href=/docs/references/filters/basic_auth/>basic_auth</a></li><li><a href=/docs/references/filters/bulk_request_mutate/>bulk_request_mutate</a></li><li><a href=/docs/references/filters/bulk_reshuffle/>bulk_reshuffle</a></li><li><a href=/docs/references/filters/bulk_response_process/>bulk_response_process</a></li><li><a href=/docs/references/filters/cache/>cache</a></li><li><a href=/docs/references/filters/clone/>clone</a></li><li><a href=/docs/references/filters/context_filter/>context_filter</a></li><li><a href=/docs/references/filters/context_limiter/>context_limiter</a></li><li><a href=/docs/references/filters/context_regex_replace/>context_regex_replace</a></li><li><a href=/docs/references/filters/date_range_precision_tuning/>date_range_precision_tuning</a></li><li><a href=/docs/references/filters/drop/>drop</a></li><li><a href=/docs/references/filters/dump/>dump</a></li><li><a href=/docs/references/filters/elasticsearch/>elasticsearch</a></li><li><a href=/docs/references/filters/elasticsearch_health_check/>elasticsearch_health_check</a></li><li><a href=/docs/references/filters/flow/>flow</a></li><li><a href=/docs/references/filters/http/>http</a></li><li><a href=/docs/references/filters/ldap_auth/>ldap_auth</a></li><li><a href=/docs/references/filters/logging/>logging</a></li><li><a href=/docs/references/filters/queue/>queue</a></li><li><a href=/docs/references/filters/ratio/>ratio</a></li><li><a href=/docs/references/filters/record/>record</a></li><li><a href=/docs/references/filters/redis_pubsub/>redis_pubsub</a></li><li><a href=/docs/references/filters/request_api_key_filter/>request_api_key_filter</a></li><li><a href=/docs/references/filters/request_api_key_limiter/>request_api_key_limiter</a></li><li><a href=/docs/references/filters/request_body_json_del/>request_body_json_del</a></li><li><a href=/docs/references/filters/request_body_json_set/>request_body_json_set</a></li><li><a href=/docs/references/filters/request_body_regex_replace/>request_body_regex_replace</a></li><li><a href=/docs/references/filters/request_client_ip_filter/>request_client_ip_filter</a></li><li><a href=/docs/references/filters/request_client_ip_limiter/>request_client_ip_limiter</a></li><li><a href=/docs/references/filters/request_header_filter/>request_header_filter</a></li><li><a href=/docs/references/filters/request_host_filter/>request_host_filter</a></li><li><a href=/docs/references/filters/request_host_limiter/>request_host_limiter</a></li><li><a href=/docs/references/filters/request_method_filter/>request_method_filter</a></li><li><a href=/docs/references/filters/request_path_filter/>request_path_filter</a></li><li><a href=/docs/references/filters/request_path_limiter/>request_path_limiter</a></li><li><a href=/docs/references/filters/request_user_filter/>request_user_filter</a></li><li><a href=/docs/references/filters/request_user_limiter/>request_user_limiter</a></li><li><a href=/docs/references/filters/response_body_regex_replace/>response_body_regex_replace</a></li><li><a href=/docs/references/filters/response_header_filter/>response_header_filter</a></li><li><a href=/docs/references/filters/response_header_format/>response_header_format</a></li><li><a href=/docs/references/filters/response_status_filter/>response_status_filter</a></li><li><a href=/docs/references/filters/retry_limiter/>retry_limiter</a></li><li><a href=/docs/references/filters/sample/>sample</a></li><li><a href=/docs/references/filters/set_basic_auth/>set_basic_auth</a></li><li><a href=/docs/references/filters/set_context/>set_context</a></li><li><a href=/docs/references/filters/set_hostname/>set_hostname</a></li><li><a href=/docs/references/filters/set_request_header/>set_request_header</a></li><li><a href=/docs/references/filters/set_request_query_args/>set_request_query_args</a></li><li><a href=/docs/references/filters/set_response/>set_response</a></li><li><a href=/docs/references/filters/set_response_header/>set_response_header</a></li><li><a href=/docs/references/filters/sleep/>sleep</a></li><li><a href=/docs/references/filters/switch/>switch</a></li><li><a href=/docs/references/filters/translog/>translog</a></li></ul></li><li><input type=checkbox id=section-82db29a871579194764c352cfff582f2 class=toggle>
<label for=section-82db29a871579194764c352cfff582f2 class="flex justify-between"><a href=/docs/references/processors/>Offline Processor</a>
<span>▾</span></label><ul><li><a href=/docs/references/processors/bulk_indexing/>bulk_indexing</a></li><li><a href=/docs/references/processors/dag/>dag</a></li><li><a href=/docs/references/processors/dump_hash/>dump_hash</a></li><li><a href=/docs/references/processors/flow_runner/>flow_runner</a></li><li><a href=/docs/references/processors/index_diff/>index_diff</a></li><li><a href=/docs/references/processors/json_indexing/>json_indexing</a></li><li><a href=/docs/references/processors/queue_consumer/>queue_consumer</a></li><li><a href=/docs/references/processors/replay/>replay</a></li></ul></li><li><input type=checkbox id=section-3de6688eceb9f20db2f0270adccf76e2 class=toggle>
<label for=section-3de6688eceb9f20db2f0270adccf76e2 class="flex justify-between"><a>Functional Component</a>
<span>▾</span></label><ul><li><a href=/docs/references/modules/floating_ip/>Floating IP</a></li><li><a href=/docs/references/modules/force_merge/>Index Segment Merging</a></li></ul></li><li><a href=/docs/references/config/>Other Configuration</a></li></ul></li><li><input type=checkbox id=section-75a1b849ec817b105e0397971f02e977 class=toggle>
<label for=section-75a1b849ec817b105e0397971f02e977 class="flex justify-between"><a>Development</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-67ac850f314cddf19527a42089315d2f class=toggle>
<label for=section-67ac850f314cddf19527a42089315d2f class="flex justify-between"><a>API Manual</a>
<span>▾</span></label><ul></ul></li><li><input type=checkbox id=section-8c2a68d691ef9d9cc23e692c13acbab6 class=toggle>
<label for=section-8c2a68d691ef9d9cc23e692c13acbab6 class="flex justify-between"><a>Plug-in Development</a>
<span>▾</span></label><ul></ul></li></ul></li><li><input type=checkbox id=section-391bcaab6cc03bd87e3373752bfd390e class=toggle>
<label for=section-391bcaab6cc03bd87e3373752bfd390e class="flex justify-between"><a>Tutorials</a>
<span>▾</span></label><ul><li><a href=/docs/tutorial/log4j2_filtering/>Apache Log4j Vulnerability Processing</a></li><li><a href=/docs/tutorial/online_query_rewrite/>Online Query Repair</a></li><li><a href=/docs/tutorial/request-logging/>Query Request Log Analysis</a></li><li><a href=/docs/tutorial/index_diff/>Index Document-Level Difference Contrast</a></li><li><a href=/docs/tutorial/proxy_kibana/>Adding a Proxy and Basic Security for Kibana</a></li><li><a href=/docs/tutorial/fix_count_in_search_response/>Compatible with the Count Structure of Query Response Results of Different Elasticsearch Versions</a></li><li><a href=/docs/tutorial/es-hadoop_integration/>Integration with Elasticsearch-Hadoop</a></li></ul></li><li><input type=checkbox id=section-7e4e95606453deb85437b78d9c3f2d72 class=toggle checked>
<label for=section-7e4e95606453deb85437b78d9c3f2d72 class="flex justify-between"><a href=/docs/user-cases/>User Cases</a>
<span>▾</span></label><ul><li><a href=/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/>How an Insurance Group Improved the Indexing Speed by 200x Times</a></li><li><a href=/docs/user-cases/stories/a_cross_region_cluster_access_locality/ class=active>Nearest Cluster Access Across Two Cloud Providers</a></li></ul></li><li><a href=/docs/troubleshooting/>FAQs</a><ul></ul></li><li><a href=/docs/release-notes/>Release Notes</a><ul></ul></li><li><a href=/docs/resources/>Other Resources</a><ul></ul></li></ul><div class=heading><select class=version-selector>
<option value>master (latest)</option>
<option value=v1.5.0>v1.5.x</option>
<option value=v1.4.0>v1.4.x</option>
<option value=v1.3.0>v1.3.x</option></select></div><ul><a class=download-btn href=https://release.infinilabs.com/>Download</a></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Nearest Cluster Access Across Two Cloud Providers</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#nearest-cluster-access-across-two-cloud-providers>Nearest Cluster Access Across Two Cloud Providers</a><ul><li><a href=#service-requirements>Service Requirements</a></li><li><a href=#deployment-of-a-single-elasticsearch-cluster-on-dual-clouds>Deployment of a Single Elasticsearch Cluster on Dual Clouds</a></li><li><a href=#configuring-infini-gateway>Configuring INFINI Gateway</a></li><li><a href=#summary-and-benefits>Summary and Benefits</a><ul><li><a href=#retrospect-of-failures-before-infini-gateway-is-introduced>Retrospect of Failures Before INFINI Gateway Is Introduced</a></li><li><a href=#benefits-of-infini-gateway>Benefits of INFINI Gateway</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=nearest-cluster-access-across-two-cloud-providers>Nearest Cluster Access Across Two Cloud Providers
<a class=anchor href=#nearest-cluster-access-across-two-cloud-providers>#</a></h1><h2 id=service-requirements>Service Requirements
<a class=anchor href=#service-requirements>#</a></h2><p>To ensure the high availability of the Elasticsearch service, Zuoyebang deploys a single Elasticsearch cluster on both Baidu Cloud and Huawei Cloud and requires that service requests be sent to the nearest cloud first.</p><h2 id=deployment-of-a-single-elasticsearch-cluster-on-dual-clouds>Deployment of a Single Elasticsearch Cluster on Dual Clouds
<a class=anchor href=#deployment-of-a-single-elasticsearch-cluster-on-dual-clouds>#</a></h2><p>The Elasticsearch cluster uses an architecture with master nodes separated from data nodes. Currently, the main cloud is used to accommodate two master nodes and the other cloud is used to accommodate another master node.
The main consideration is that infrastructure failures are mostly dedicated line failures, and the overall breakdown of a provider&rsquo;s cloud rarely occurs. Therefore, the main cloud is configured. When a dedicated line failure occurs, the Elasticsearch cluster on the main cloud is read/write and service traffic can be switched to the main cloud.</p><p>The configuration is as follows:</p><p>First, complete the following settings on the master nodes:</p><pre><code>cluster.routing.allocation.awareness.attributes: zone_id
cluster.routing.allocation.awareness.force.zone_id.values: zone_baidu,zone_huawei
</code></pre><p>Then, perform the following settings on data nodes on Baidu Cloud:</p><pre><code>node.attr.zone_id: zone_baidu
</code></pre><p>Perform the following settings on data nodes on Huawei Cloud:</p><pre><code>node.attr.zone_id: zone_huawei
</code></pre><p>Indexes are created using one copy, which can ensure that the same copy of data exists on Baidu Cloud and Huawei Cloud.</p><p>The service access mode is shown as follows:</p><p><img src=/img/cross_region_cluster.jpg alt="Nearest Access to a Single Cluster Across Clouds"></p><ul><li>Baidu Cloud service -> Baidu lb -> INFINI Gateway (Baidu Cloud) -> Elasticsearch (data nodes on Baidu Cloud)</li><li>Huawei Cloud service -> Huawei lb -> INFINI Gateway (Huawei Cloud) -> Elasticsearch (data nodes on Huawei Cloud)</li></ul><h2 id=configuring-infini-gateway>Configuring INFINI Gateway
<a class=anchor href=#configuring-infini-gateway>#</a></h2><p>Elasticsearch uses the
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/master/search-search.html#search-preference>Preference</a> parameter to set the request access priority. Set the default Preference parameter for requests on INFINI Gateway inside the two clouds so that requests inside each cloud are sent to data nodes in the local cloud first, thereby implementing nearest access of requests.</p><p>The specific configuration on INFINI Gateway inside Baidu Cloud is as follows (the configuration on INFINI Gateway inside Huawei Cloud is basically the same and is not provided here):</p><pre><code>path.data: data
path.logs: log

entry:
- name: es-test
  enabled: true
  router: default
  network:
      binding: 0.0.0.0:9200
      reuse_port: true

router:
- name: default
  default_flow: es-test

flow:
- name: es-test
  filter:
    - set_request_query_args:
        args:
          - preference -&gt; _prefer_nodes:data-baidu01,data-baidu02 #Set _prefer_nodes of Preference to all Baidu data nodes so that Baidu Cloud service accesses the nodes of Baidu Cloud first, thereby avoiding cross-cloud access to the maximum extent and enabling the service to run more smoothly.
        when:
          contains:
            _ctx.request.path: /_search
    - elasticsearch:
        elasticsearch: default  
        refresh:
            enabled: true
            interval: 10s
        roles:                    
            include:
            - data #Set it to data so that requests are sent only to the data node.
        tags:
          include:
            - zone_id: zone_baidu #Requests are forwarded only to nodes in Baidu Cloud.


elasticsearch:
- name: default
  enabled: true
  endpoint: http://10.10.10.10:9200
  discovery:
      enabled: true
  refresh:
      enabled: true
      interval: 10s
  basic_auth:
      username: elastic
      password: elastic
</code></pre><h2 id=summary-and-benefits>Summary and Benefits
<a class=anchor href=#summary-and-benefits>#</a></h2><h3 id=retrospect-of-failures-before-infini-gateway-is-introduced>Retrospect of Failures Before INFINI Gateway Is Introduced
<a class=anchor href=#retrospect-of-failures-before-infini-gateway-is-introduced>#</a></h3><p>When Baidu Cloud service accesses the Elasticsearch cluster, it pulls daily incremental data from the Hive cluster and synchronizes it to Elasticsearch. Some tasks may fail and data is synchronized again. As a result, some data is pulled from the Elasticsearch node inside Huawei Cloud to the Hive cluster of Baidu Cloud. The huge amount of data triggers an alarm about cross-cloud dedicated line traffic monitoring. Online services, MySQL, Redis, and Elasticsearch use the same dedicated line.
The impact of the failures is huge. The temporary solution is to add the Preference parameter to the service modification statement so that the services only pull local cloud data, reducing the occupancy of the dedicated line. The service transformation and maintenance costs are high. In addition, DBA has worries that there are omissions in service transformation, the Preference parameter is ignored for new services, and later adjustment costs are high. These are always risk points.</p><h3 id=benefits-of-infini-gateway>Benefits of INFINI Gateway
<a class=anchor href=#benefits-of-infini-gateway>#</a></h3><p>After INFINI Gateway is added to the original architecture, services can preferentially access the local cloud with the service code not modified. In this way, CPU resources of the server are fully utilized and all CPU resources of each node are used.</p><blockquote><p>Author: Zhao Qing, former DBA of NetEase, mainly involved in the O&M of Oracle, MySQL, Redis, Elasticsearch, Tidb, OB, and other components, as well as O&M automation, platform-based application, and intelligence. Now he is working in Zuoyebang.</p></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li><a href=/zh/docs/user-cases/stories/a_cross_region_cluster_access_locality/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Chinese</a></li><li class=active><a href=/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></li></ul></div><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script>(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:2567416,hjsv:6};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VV6PGDHH84"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-VV6PGDHH84');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#nearest-cluster-access-across-two-cloud-providers>Nearest Cluster Access Across Two Cloud Providers</a><ul><li><a href=#service-requirements>Service Requirements</a></li><li><a href=#deployment-of-a-single-elasticsearch-cluster-on-dual-clouds>Deployment of a Single Elasticsearch Cluster on Dual Clouds</a></li><li><a href=#configuring-infini-gateway>Configuring INFINI Gateway</a></li><li><a href=#summary-and-benefits>Summary and Benefits</a><ul><li><a href=#retrospect-of-failures-before-infini-gateway-is-introduced>Retrospect of Failures Before INFINI Gateway Is Introduced</a></li><li><a href=#benefits-of-infini-gateway>Benefits of INFINI Gateway</a></li></ul></li></ul></li></ul></nav></aside></main></body></html>