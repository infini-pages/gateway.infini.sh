<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.79.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Apache Log4j Vulnerability Processing #  CVE Address
 https://github.com/advisories/GHSA-jfh8-c2jp-5v3q
Vulnerability Description
Apache Log4j is a very popular open source logging toolkit used for the Java runtime environment. Many Java frameworks including Elasticsearch of the latest version, use this component. Therefore, the scope of impact is huge.
The latest vulnerability existing in the execution of Apache Log4j&rsquo;s remote code was revealed recently. Attackers can construct malicious requests and utilize this vulnerability to execute arbitrary code on a target server."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Apache Log4j Vulnerability Processing"><meta property="og:description" content="Apache Log4j Vulnerability Processing #  CVE Address
 https://github.com/advisories/GHSA-jfh8-c2jp-5v3q
Vulnerability Description
Apache Log4j is a very popular open source logging toolkit used for the Java runtime environment. Many Java frameworks including Elasticsearch of the latest version, use this component. Therefore, the scope of impact is huge.
The latest vulnerability existing in the execution of Apache Log4j&rsquo;s remote code was revealed recently. Attackers can construct malicious requests and utilize this vulnerability to execute arbitrary code on a target server."><meta property="og:type" content="article"><meta property="og:url" content="/docs/tutorial/log4j2_filtering/"><title>Apache Log4j Vulnerability Processing | INFINI Gateway</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=alternate hreflang=zh href=/zh/docs/tutorial/log4j2_filtering/ title="Apache Log4j 漏洞处置"><link rel=stylesheet href=/book.min.86778a3f4df1b5b61556a975dd0ee3bd2c03aeee5a2e203fb93ecbd71224869e.css integrity="sha256-hneKP03xtbYVVql13Q7jvSwDru5aLiA/uT7L1xIkhp4="><script defer src=/en.search.min.35ecdbc4b004fe04886dc86c3cb0d729eab3c74bdb861a2e8df23ce8d2242cc2.js integrity="sha256-NezbxLAE/gSIbchsPLDXKeqzx0vbhhoujfI86NIkLMI="></script><script defer src=/js/jquery-2.x.min.js></script><script defer src=/js/doc.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><img src=/img/logo-en.svg alt=Logo></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/overview/>Overview</a><ul></ul></li><li><input type=checkbox id=section-f1b7c1b2e5dd43526e77637c475d35b8 class=toggle>
<label for=section-f1b7c1b2e5dd43526e77637c475d35b8 class="flex justify-between"><a>Quick Start</a>
<span>▾</span></label><ul><li><a href=/docs/getting-started/install/>Installing the Gateway</a></li><li><a href=/docs/getting-started/configuration/>Configuring the Gateway</a></li><li><a href=/docs/getting-started/docker/>Container Deployment</a></li><li><a href=/docs/getting-started/optimization/>System Optimization</a></li><li><a href=/docs/getting-started/benchmark/>Performance Test</a></li></ul></li><li><input type=checkbox id=section-fb088f8a9be33f7f260ad2b140bb7bdc class=toggle>
<label for=section-fb088f8a9be33f7f260ad2b140bb7bdc class="flex justify-between"><a>Reference</a>
<span>▾</span></label><ul><li><a href=/docs/references/entry/>Service Entry</a></li><li><a href=/docs/references/router/>Service Router</a></li><li><a href=/docs/references/flow/>Handling Flow</a></li><li><a href=/docs/references/elasticsearch/>Elasticsearch</a></li><li><a href=/docs/references/context/>Request Context</a></li><li><input type=checkbox id=section-a53d1bd91095fa28aef70cee327a5121 class=toggle>
<label for=section-a53d1bd91095fa28aef70cee327a5121 class="flex justify-between"><a href=/docs/references/filters/>Online Filter</a>
<span>▾</span></label><ul><li><a href=/docs/references/filters/echo/>echo</a></li><li><a href=/docs/references/filters/basic_auth/>basic_auth</a></li><li><a href=/docs/references/filters/bulk_request_mutate/>bulk_request_mutate</a></li><li><a href=/docs/references/filters/bulk_reshuffle/>bulk_reshuffle</a></li><li><a href=/docs/references/filters/bulk_response_process/>bulk_response_process</a></li><li><a href=/docs/references/filters/cache/>cache</a></li><li><a href=/docs/references/filters/clone/>clone</a></li><li><a href=/docs/references/filters/context_filter/>context_filter</a></li><li><a href=/docs/references/filters/context_limiter/>context_limiter</a></li><li><a href=/docs/references/filters/context_regex_replace/>context_regex_replace</a></li><li><a href=/docs/references/filters/date_range_precision_tuning/>date_range_precision_tuning</a></li><li><a href=/docs/references/filters/drop/>drop</a></li><li><a href=/docs/references/filters/dump/>dump</a></li><li><a href=/docs/references/filters/elasticsearch/>elasticsearch</a></li><li><a href=/docs/references/filters/elasticsearch_health_check/>elasticsearch_health_check</a></li><li><a href=/docs/references/filters/flow/>flow</a></li><li><a href=/docs/references/filters/http/>http</a></li><li><a href=/docs/references/filters/ldap_auth/>ldap_auth</a></li><li><a href=/docs/references/filters/logging/>logging</a></li><li><a href=/docs/references/filters/queue/>queue</a></li><li><a href=/docs/references/filters/ratio/>ratio</a></li><li><a href=/docs/references/filters/record/>record</a></li><li><a href=/docs/references/filters/redis_pubsub/>redis_pubsub</a></li><li><a href=/docs/references/filters/request_api_key_filter/>request_api_key_filter</a></li><li><a href=/docs/references/filters/request_api_key_limiter/>request_api_key_limiter</a></li><li><a href=/docs/references/filters/request_body_json_del/>request_body_json_del</a></li><li><a href=/docs/references/filters/request_body_json_set/>request_body_json_set</a></li><li><a href=/docs/references/filters/request_body_regex_replace/>request_body_regex_replace</a></li><li><a href=/docs/references/filters/request_client_ip_filter/>request_client_ip_filter</a></li><li><a href=/docs/references/filters/request_client_ip_limiter/>request_client_ip_limiter</a></li><li><a href=/docs/references/filters/request_header_filter/>request_header_filter</a></li><li><a href=/docs/references/filters/request_host_filter/>request_host_filter</a></li><li><a href=/docs/references/filters/request_host_limiter/>request_host_limiter</a></li><li><a href=/docs/references/filters/request_method_filter/>request_method_filter</a></li><li><a href=/docs/references/filters/request_path_filter/>request_path_filter</a></li><li><a href=/docs/references/filters/request_path_limiter/>request_path_limiter</a></li><li><a href=/docs/references/filters/request_user_filter/>request_user_filter</a></li><li><a href=/docs/references/filters/request_user_limiter/>request_user_limiter</a></li><li><a href=/docs/references/filters/response_body_regex_replace/>response_body_regex_replace</a></li><li><a href=/docs/references/filters/response_header_filter/>response_header_filter</a></li><li><a href=/docs/references/filters/response_header_format/>response_header_format</a></li><li><a href=/docs/references/filters/response_status_filter/>response_status_filter</a></li><li><a href=/docs/references/filters/retry_limiter/>retry_limiter</a></li><li><a href=/docs/references/filters/sample/>sample</a></li><li><a href=/docs/references/filters/set_basic_auth/>set_basic_auth</a></li><li><a href=/docs/references/filters/set_context/>set_context</a></li><li><a href=/docs/references/filters/set_hostname/>set_hostname</a></li><li><a href=/docs/references/filters/set_request_header/>set_request_header</a></li><li><a href=/docs/references/filters/set_request_query_args/>set_request_query_args</a></li><li><a href=/docs/references/filters/set_response/>set_response</a></li><li><a href=/docs/references/filters/set_response_header/>set_response_header</a></li><li><a href=/docs/references/filters/sleep/>sleep</a></li><li><a href=/docs/references/filters/switch/>switch</a></li><li><a href=/docs/references/filters/translog/>translog</a></li></ul></li><li><input type=checkbox id=section-82db29a871579194764c352cfff582f2 class=toggle>
<label for=section-82db29a871579194764c352cfff582f2 class="flex justify-between"><a href=/docs/references/processors/>Offline Processor</a>
<span>▾</span></label><ul><li><a href=/docs/references/processors/bulk_indexing/>bulk_indexing</a></li><li><a href=/docs/references/processors/dag/>dag</a></li><li><a href=/docs/references/processors/dump_hash/>dump_hash</a></li><li><a href=/docs/references/processors/flow_runner/>flow_runner</a></li><li><a href=/docs/references/processors/index_diff/>index_diff</a></li><li><a href=/docs/references/processors/json_indexing/>json_indexing</a></li><li><a href=/docs/references/processors/queue_consumer/>queue_consumer</a></li><li><a href=/docs/references/processors/replay/>replay</a></li></ul></li><li><input type=checkbox id=section-3de6688eceb9f20db2f0270adccf76e2 class=toggle>
<label for=section-3de6688eceb9f20db2f0270adccf76e2 class="flex justify-between"><a>Functional Component</a>
<span>▾</span></label><ul><li><a href=/docs/references/modules/floating_ip/>Floating IP</a></li><li><a href=/docs/references/modules/force_merge/>Index Segment Merging</a></li></ul></li><li><a href=/docs/references/config/>Other Configuration</a></li></ul></li><li><input type=checkbox id=section-75a1b849ec817b105e0397971f02e977 class=toggle>
<label for=section-75a1b849ec817b105e0397971f02e977 class="flex justify-between"><a>Development</a>
<span>▾</span></label><ul><li><input type=checkbox id=section-67ac850f314cddf19527a42089315d2f class=toggle>
<label for=section-67ac850f314cddf19527a42089315d2f class="flex justify-between"><a>API Manual</a>
<span>▾</span></label><ul></ul></li><li><input type=checkbox id=section-8c2a68d691ef9d9cc23e692c13acbab6 class=toggle>
<label for=section-8c2a68d691ef9d9cc23e692c13acbab6 class="flex justify-between"><a>Plug-in Development</a>
<span>▾</span></label><ul></ul></li></ul></li><li><input type=checkbox id=section-391bcaab6cc03bd87e3373752bfd390e class=toggle checked>
<label for=section-391bcaab6cc03bd87e3373752bfd390e class="flex justify-between"><a>Tutorials</a>
<span>▾</span></label><ul><li><a href=/docs/tutorial/log4j2_filtering/ class=active>Apache Log4j Vulnerability Processing</a></li><li><a href=/docs/tutorial/online_query_rewrite/>Online Query Repair</a></li><li><a href=/docs/tutorial/request-logging/>Query Request Log Analysis</a></li><li><a href=/docs/tutorial/index_diff/>Index Document-Level Difference Contrast</a></li><li><a href=/docs/tutorial/proxy_kibana/>Adding a Proxy and Basic Security for Kibana</a></li><li><a href=/docs/tutorial/fix_count_in_search_response/>Compatible with the Count Structure of Query Response Results of Different Elasticsearch Versions</a></li><li><a href=/docs/tutorial/es-hadoop_integration/>Integration with Elasticsearch-Hadoop</a></li></ul></li><li><input type=checkbox id=section-7e4e95606453deb85437b78d9c3f2d72 class=toggle>
<label for=section-7e4e95606453deb85437b78d9c3f2d72 class="flex justify-between"><a href=/docs/user-cases/>User Cases</a>
<span>▾</span></label><ul><li><a href=/docs/user-cases/stories/indexing_speedup_for_big_index_rebuild/>How an Insurance Group Improved the Indexing Speed by 200x Times</a></li><li><a href=/docs/user-cases/stories/a_cross_region_cluster_access_locality/>Nearest Cluster Access Across Two Cloud Providers</a></li></ul></li><li><a href=/docs/troubleshooting/>FAQs</a><ul></ul></li><li><a href=/docs/release-notes/>Release Notes</a><ul></ul></li><li><a href=/docs/resources/>Other Resources</a><ul></ul></li></ul><div class=heading><select class=version-selector>
<option value>master (latest)</option>
<option value=v1.5.0>v1.5.x</option>
<option value=v1.4.0>v1.4.x</option>
<option value=v1.3.0>v1.3.x</option></select></div><ul><a class=download-btn href=https://release.infinilabs.com/>Download</a></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Apache Log4j Vulnerability Processing</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#apache-log4j-vulnerability-processing>Apache Log4j Vulnerability Processing</a><ul><li><a href=#handling-method>Handling Method</a></li><li><a href=#reference-configuration>Reference Configuration</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=apache-log4j-vulnerability-processing>Apache Log4j Vulnerability Processing
<a class=anchor href=#apache-log4j-vulnerability-processing>#</a></h1><p>CVE Address</p><p><a href=https://github.com/advisories/GHSA-jfh8-c2jp-5v3q>https://github.com/advisories/GHSA-jfh8-c2jp-5v3q</a></p><p>Vulnerability Description</p><p>Apache Log4j is a very popular open source logging toolkit used for the Java runtime environment. Many Java frameworks including Elasticsearch of the latest version, use this component. Therefore, the scope of impact is huge.</p><p>The latest vulnerability existing in the execution of Apache Log4j&rsquo;s remote code was revealed recently. Attackers can construct malicious requests and utilize this vulnerability to execute arbitrary code on a target server. As a result, the server can be controlled by hackers, who can then conduct page tampering, data theft, mining, extortion, and other behaviors. Users who use this component are advised to immediately initiate emergency response for fixing.</p><p>Basically, if a log output by Log4j contains the keyword <code>${</code>, the log is replaced as a variable and then the variable operation is executed. Attackers can maliciously construct log content to make Java processes to execute arbitrary commands, achieving the attack purpose.</p><p>Vulnerability Level: very urgent</p><p>The vulnerability is caused by the lookup function provided by Log4j2. This function allows developers to read configurations in the environment by using a number of protocols. However, the input is not strictly judged in the implementation, resulting in the vulnerability.</p><p>Impact Scope: Java products: Apache Log4j 2.x &lt; 2.15.0-rc2</p><p>Attack Detection</p><p>You can check logs for <code>jndi:ldap://</code>, <code>jndi:rmi</code>, and other characters to find out possible attacks.</p><h2 id=handling-method>Handling Method
<a class=anchor href=#handling-method>#</a></h2><p>If Elasticsearch does not support configuration modification, Jar package replacement of Log4j, or cluster restart, you can use INFINI Gateway to intercept requests, replace parameters, and even directly block requests.
You can use INFINI Gateway to check parameters in requests sent to Elasticsearch and replace or reject content that contains the sensitive keyword <code>${</code>.
In this way, INFINI Gateway can prevent the execution of malicious attack commands during Log4j logging after attack-contained requests are sent to Elasticsearch, thereby preventing attacks.</p><h2 id=reference-configuration>Reference Configuration
<a class=anchor href=#reference-configuration>#</a></h2><p>Download the latest <code>1.5.0-SNAPSHOT</code> version:
<a href=http://release.elasticsearch.cn/gateway/snapshot/>http://release.elasticsearch.cn/gateway/snapshot/</a></p><p>The <code>context_filter</code> filter of INFINI Gateway can be used to detect the keywords of the request context <code>_ctx.request.to_string</code> and filter out malicious traffic, thereby blocking attacks.</p><pre><code>path.data: data
path.logs: log

entry:
  - name: es_entrypoint
    enabled: true
    router: default
    max_concurrency: 20000
    network:
      binding: 0.0.0.0:8000

router:
  - name: default
    default_flow: main_flow

flow:
  - name: main_flow
    filter:
      - context_filter:
          context: _ctx.request.to_string
          action: redirect_flow
          status: 403
          flow: log4j_matched_flow
          must_not: # any match will be filtered
            regex:
              - \$\{.*?\}
              - &quot;%24%7B.*?%7D&quot; #urlencode
            contain:
              - &quot;jndi:&quot;
              - &quot;jndi:ldap:&quot;
              - &quot;jndi:rmi:&quot;
              - &quot;jndi%3A&quot; #urlencode
              - &quot;jndi%3Aldap%3A&quot; #urlencode
              - &quot;jndi%3Armi%3A&quot; #urlencode
      - elasticsearch:
          elasticsearch: es-server
  - name: log4j_matched_flow
    filter:
      - echo:
          message: 'Apache Log4j 2, Boom!'

elasticsearch:
  - name: es-server
    enabled: true
    endpoints:
      - http://localhost:9200
</code></pre><p>Use urlencode to convert the test command <code>${java:os}</code> into <code>%24%7Bjava%3Aos%7D</code>.</p><p>Request calling execution result when requests do not need to pass through the gateway:</p><pre><code>~%  curl 'http://localhost:9200/index1/_search?q=%24%7Bjava%3Aos%7D' 
{&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;index_not_found_exception&quot;,&quot;reason&quot;:&quot;no such index&quot;,&quot;resource.type&quot;:&quot;index_or_alias&quot;,&quot;resource.id&quot;:&quot;index1&quot;,&quot;index_uuid&quot;:&quot;_na_&quot;,&quot;index&quot;:&quot;index1&quot;}],&quot;type&quot;:&quot;index_not_found_exception&quot;,&quot;reason&quot;:&quot;no such index&quot;,&quot;resource.type&quot;:&quot;index_or_alias&quot;,&quot;resource.id&quot;:&quot;index1&quot;,&quot;index_uuid&quot;:&quot;_na_&quot;,&quot;index&quot;:&quot;index1&quot;},&quot;status&quot;:404}%   
</code></pre><p>Logs on Elasticsearch are as follows:</p><pre><code>[2021-12-11T01:49:50,303][DEBUG][r.suppressed             ] path: /index1/_search, params: {q=Mac OS X 10.13.4 unknown, architecture: x86_64-64, index=index1}
org.elasticsearch.index.IndexNotFoundException: no such index
	at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.infe(IndexNameExpressionResolver.java:678) ~[elasticsearch-5.6.15.jar:5.6.15]
	at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.innerResolve(IndexNameExpressionResolver.java:632) ~[elasticsearch-5.6.15.jar:5.6.15]
	at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.resolve(IndexNameExpressionResolver.java:580) ~[elasticsearch-5.6.15.jar:5.6.15]

</code></pre><p>The logs above show that <code>q=${java:os}</code> in query conditions is executed and is changed to <code>q=Mac OS X 10.13.4 unknown, architecture: x86_64-64, index=index1</code>.</p><p>Request calling execution result when requests need to pass through the gateway:</p><pre><code>medcl@Medcl:~%  curl 'http://localhost:8000/index1/_search?q=%24%7Bjava%3Aos%7D' 

Apache Log4j 2, Boom!%    
</code></pre><p>The logs above show that requests are filtered out.</p><p>You can try other commands to check whether malicious requests are intercepted:</p><pre><code>#{java:vm}
~%  curl 'http://localhost:9200/index/_search?q=%24%7Bjava%3Avm%7D'
[2021-12-11T02:36:04,764][DEBUG][r.suppressed             ] [Medcl-2.local] path: /index/_search, params: {q=OpenJDK 64-Bit Server VM (build 25.72-b15, mixed mode), index=index}

~%  curl 'http://localhost:8000/index/_search?q=%24%7Bjava%3Avm%7D'
Apache Log4j 2, Boom!% 

#{jndi:rmi://localhost:1099/api}
~%  curl 'http://localhost:9200/index/_search?q=%24%7Bjndi%3Armi%3A%2F%2Flocalhost%3A1099%2Fapi%7D'
2021-12-11 03:35:06,493 elasticsearch[YOmFJsW][search][T#3] ERROR An exception occurred processing Appender console java.lang.SecurityException: attempt to add a Permission to a readonly Permissions object

~%  curl 'http://localhost:8000/index/_search?q=%24%7Bjndi%3Armi%3A%2F%2Flocalhost%3A1099%2Fapi%7D'
Apache Log4j 2, Boom!% 
</code></pre><blockquote><p>The benefits of using INFINI Gateway is that no change needs to be made to the Elasticsearch server, especially in large-scale cluster scenarios. The flexible INFINI Gateway can significantly reduce workload, improve efficiency, shorten the security processing time, and reduce enterprise risks.</p></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div class=book-languages tabindex=0 aria-haspopup=true><ul><li class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</li></ul><ul class=book-languages-list><li><a href=/zh/docs/tutorial/log4j2_filtering/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Chinese</a></li><li class=active><a href=/ class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></li></ul></div><div class="flex align-center footer">©INFINI.LTD, All Rights Reserved.</div><script>(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:2567416,hjsv:6};a=o.getElementsByTagName('head')[0];r=o.createElement('script');r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r);})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VV6PGDHH84"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-VV6PGDHH84');</script><script type=text/javascript>var _smartsupp=_smartsupp||{};_smartsupp.key='691ff544d18a237005a011a7290b839d8fe811a4';window.smartsupp||(function(d){var s,c,o=smartsupp=function(){o._.push(arguments)};o._=[];s=d.getElementsByTagName('script')[0];c=d.createElement('script');c.type='text/javascript';c.charset='utf-8';c.async=true;c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);})(document);</script></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#apache-log4j-vulnerability-processing>Apache Log4j Vulnerability Processing</a><ul><li><a href=#handling-method>Handling Method</a></li><li><a href=#reference-configuration>Reference Configuration</a></li></ul></li></ul></nav></aside></main></body></html>